<!--
  @GameName：模仿贪吃蛇
  @Author：liukaiyuan
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #main {
      width: 400px;
      height: 400px;
      border: 1px solid #999;
      position: relative;
      margin: 30px auto;
    }

    .unit {
      position: absolute;
      background-color: yellow;
      border-radius: 50%;
      width: 20px;
      height: 20px;
    }

    .game {
      border: 1px solid #ccc;
    }

    .btn {
      display: flex;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .btn * {
      margin-left: 4px;
      margin-right: 4px;
    }
    /*
    蛇头样式
    */

    .unit:nth-of-type(1) {}
    /*
    食物样式
    */

    #food {
      background: radial-gradient(ellipse at center, rgba(239, 197, 202, 1) 0%, rgba(210, 75, 90, 1) 26%, rgba(186, 39, 55, 1) 52%, rgba(241, 142, 153, 1) 100%);
      box-shadow: 0 0 6px rgba(240, 113, 70, .8), 0 0 14px rgba(204, 0, 0, .4);
    }

  </style>
</head>

<body>

  <div class="game">
    <div id="main"></div>
    <div class="btn">
      <button type="button" onclick="location.reload()">重新开始</button>      
      <button type="button" onclick="startMove()">开始</button>
      <button type="button" onclick="stopMove()">暂停</button> 你的分数：
      <strong id="score">0</strong> - 最高纪录：
      <span id="record">0</span>
    </div>
  </div>


  <script>
    let snake = []; //组成蛇的蛇单元数组，第一个snake[0]是蛇头
    let timer; //定时器
    let mainWidth = 400; //容器宽度
    let mainHeight = 400;
    let unitWidth = 20; //蛇单元宽度
    let unitHeight = 20;
    let speed = 200; // 运动速度
    let dir = 'left'; //蛇头运动方向
    let lastStatus = {}; //用来记录蛇尾上个状态的变量，为了添加新的蛇尾到蛇数组 
    let food = {}; //食物模型
    let color = ['yellow', '#607d8b', '#9e9e9e', '#795548', '#ff5722', '#ff9800', '#ffeb3b', '#8bc34a', '#4caf50',
      '#009688', '#03a9f4', '#673ab7', '#e91e63'
    ];
    //蛇单元模型
    let snakeUnit = {
      left: 0, //左边距
      top: 0, //上边距
      dom: '[DOM Object]', //单元的dom元素
      //direction: 'top' //单元前进的方向
    };
    //先在蛇数组里放入第一个蛇单元，即蛇头
    snake.push({
      left: parseInt(Math.random() * (mainWidth - unitWidth - 0) / unitWidth) * unitWidth,
      top: parseInt(Math.random() * (mainHeight - unitHeight - 0) / unitHeight) * unitHeight,
      dom: createUnit(),
     //direction: 'top'
    });
    //初始化蛇头
    renderSnake(snake[0]);
    //初始化食物
    createFood();
    //将初始化的蛇头、食物添进DOM中
    document.querySelector('#main').appendChild(food.dom);
    document.querySelector('#main').appendChild(snake[0].dom);
    //初始化时、获取存储的最高记录或新创建储存纪录
    //localStorage在edge浏览器中需要服务器环境
    if (localStorage.getItem('tanchiseMaxScore')) {
      document.querySelector('#record').innerHTML = localStorage.getItem('tanchiseMaxScore');
    } else {
      localStorage.setItem('tanchiseMaxScore', 0);
      document.querySelector('#record').innerHTML = localStorage.getItem('tanchiseMaxScore');
    };
    //创建蛇单元的dom元素
    function createUnit() {
      let domUnit = document.createElement('div');
      domUnit.className = 'unit';
      return domUnit;
    }
    //计算蛇数组的位置
    function renderSnake(snake) {
      if (Array.isArray(snake)) {
        //渲染所有蛇单元的位置
        snake.forEach((item, index) => {
          item.dom.style.left = item.left + 'px';
          item.dom.style.top = item.top + 'px';
          item.dom.style.backgroundColor = color[index % color.length];
        })
      } else {
        //单个蛇单元
        snake.dom.style.left = snake.left + 'px';
        snake.dom.style.top = snake.top + 'px';
      }
    };
    //创建食物
    function createFood() {
      //食物合法性
      let foodValid = true;
      //随机生成食物  
      food = {
        left: parseInt(Math.random() * (mainWidth - unitWidth - 0) / unitWidth) * unitWidth, //最左是0，最右是380
        top: parseInt(Math.random() * (mainHeight - unitHeight - 0) / unitHeight) * unitHeight,
        dom: createUnit()
      };
      //判断食物位置是否和蛇体有冲突
      for (let i = 0; i < snake.length; i++) {
        if (food.left == snake[i].left && food.top == snake[i].top) {
          foodValid = false;
          break;
        }
      };
      if (foodValid) {
        //食物的id
        food.dom.id = 'food';
        renderSnake(food);
      } else {
        //重新生成食物
        createFood()
      }
    };
    //开启定时器
    function startMove() {
      
      timer = setInterval(function () {

        //1、先计算其他蛇单元 (除了蛇头)
        for (let i = snake.length - 1; i > 0; i--) {
          snake[i].left = snake[i - 1].left;
          snake[i].top = snake[i - 1].top;
          //snake[i].direction = snake[i - 1].direction;
        };
        // 再根据按下的键得出蛇头现在应该往哪运动
        //snake[0].direction = dir;
        //2、最后计算蛇头运动坐标
        switch (dir) {
          case 'top':
            snake[0].top -= unitHeight;
            break;
          case 'left':
            snake[0].left -= unitWidth;
            break;
          case 'right':
            snake[0].left += unitHeight;
            break;
          case 'bottom':
            snake[0].top += unitWidth;
            break;
        };

        //检测到蛇头坐标（超越、碰撞）到墙壁，注意这里还没有真正渲染left、top的位置
        if (snake[0].left < 0 || snake[0].top < 0 || snake[0].left >= mainWidth || snake[0].top >= mainHeight) {
          console.log(`撞墙了`);
          recordScore(+document.querySelector('#score').innerHTML);
          clearInterval(timer);
          return;
        };
        //检测蛇头是否撞到自己
        for (let i = 1; i < snake.length; i++) {
          if (snake[i].left == snake[0].left && snake[i].top == snake[0].top) {
            console.log(`撞到自己了`);
            recordScore(+document.querySelector('#score').innerHTML);
            clearInterval(timer);
            return;
          };
        };

        //渲染所有蛇单元在页面的位置
        renderSnake(snake);
        //吃到食物
        if (snake[0].left == food.left && snake[0].top == food.top) {
          //1、改变速度
          if (speed >= 80) {
            speed -= 10;
          };
          document.querySelector('#score').innerHTML = +document.querySelector('#score').innerHTML + 1;
          //2、重新开启更快速度的定时器 
          clearInterval(timer);
          startMove();

          snake.push({ //吃到食物、就将上个蛇尾的状态加入蛇数组
            left: lastStatus.left,
            top: lastStatus.top,
            dom: createUnit(),
            //direction: lastStatus.direction
          });

          //更新所有蛇单元在页面的位置
          renderSnake(snake);
          //更新蛇尾
          document.querySelector('#main').appendChild(snake[snake.length - 1].dom);
          //创建新的食物模型
          createFood();
          //从DOM中删掉上一个食物
          document.querySelector('#main').removeChild(document.querySelector('#food'));
          //加入新的食物DOM到页面
          document.querySelector('#main').appendChild(food.dom);
        };

        //更新并记录最后一个蛇单元的状态
        lastStatus = {
          left: snake[snake.length - 1].left,
          top: snake[snake.length - 1].top,
          //direction: snake[snake.length - 1].direction
        };

      }, speed)


    };
    //关闭定时器
    function stopMove() {
      clearInterval(timer);
    };
    //记录最高分数
    function recordScore(newRecord) {
      if (localStorage.getItem('tanchiseMaxScore')) {
        if (+localStorage.getItem('tanchiseMaxScore') < +newRecord) {
          localStorage.setItem('tanchiseMaxScore', newRecord)
        }
      }
    }
    document.addEventListener('keydown', function (e) {
      //两次按键相同
      if (
        (dir == 'left' && e.keyCode == 37) ||
        (dir == 'right' && e.keyCode == 39) ||
        (dir == 'top' && e.keyCode == 38) ||
        (dir == 'bottom' && e.keyCode == 40)
      ) {
        return;
      }　
      else {
        if (snake.length > 1) {
          //长度大于1时，按键相反，取原来正常的方向（解决按键相反的冲突）
          if (e.keyCode == 37 && dir == 'right') {
            dir = 'right';
            return;
          }
          if (e.keyCode == 38 && dir == 'bottom') {
            dir = 'bottom';
            return;
          }
          if (e.keyCode == 39 && dir == 'left') {
            dir = 'left';
            return;
          }
          if (e.keyCode == 40 && dir == 'top') {
            dir = 'top';
            return;
          }
          //正常情况下
          if (e.keyCode == 37) {
            dir = 'left';
          }
          if (e.keyCode == 38) {
            dir = 'top';
          }
          if (e.keyCode == 39) {
            dir = 'right';
          }
          if (e.keyCode == 40) {
            dir = 'bottom';
          }
        } else {
          //只有蛇头时
          switch (e.keyCode) {
            case 37: //左
              dir = 'left';
              break;
            case 38: //上
              dir = 'top';
              break;
            case 39: //右
              dir = 'right';
              break;
            case 40: //下
              dir = 'bottom';
              break;
          }
        }

      }

    });

  </script>
</body>

</html>
